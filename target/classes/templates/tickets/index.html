<!DOCTYPE html>
<html xmins:th="http://www.thymeleaf.org">

	<head th:insert="~{fragments/fragments :: head}">
	</head>

	<body class="d-flex flex-column min-vh-100">
		<header>
			<nav th:replace="~{fragments/navbar :: navbar}"></nav>
		</header>

		<!--TICKET INDEX-->

		<main class="container">

			<h1 class="mt-2">Tickets</h1>
			<div class="row">
				<div class="d-flex justify-content-between w-100 mb-3">
					<!--search bar-->
					<form th:action="@{/tickets}" method="GET" class="d-flex flex-grow-1">
						<div class="input-group input-group-sm">
							<span class="input-group-text" id="inputGroup-sizing-sm">Search for ticket by title</span>
							<input type="text" class="form-control" name="title">
							<input type="submit" class="form-control btn btn-sm btn-success">
						</div>
					</form>


				</div>
			</div>


			<div class="d-flex justify-content-between align-items-center mb-3">
				<!--filter by status-->
				<div class="input-group input-group-sm me-1">
					<span class="input-group-text">Filter by status</span>
					<div class="btn-group" role="group">
							<form th:action="@{/tickets}" method="GET">
								<button type="submit" name="status" class="btn btn-secondary"
									th:classappend="${status == null or status == 'None'} ? 'active' : ''">None</button>
							</form>

						<th:block sec:authorize="hasAuthority('ADMIN')">
							<form th:action="@{/tickets}" method="GET">
								<button type="submit" name="status" th:value="'To do'" th:text="'To do'"
									class="btn btn-secondary"
									th:classappend="${status == 'To do'} ? 'active' : ''"></button>
							</form>
						</th:block>
						<form th:action="@{/tickets}" method="GET">
							<button type="submit" name="status" th:value="'Doing'" th:text="'Doing'"
								class="btn btn-secondary"
								th:classappend="${status == 'Doing'} ? 'active' : ''"></button>
						</form>
						<form th:action="@{/tickets}" method="GET">
							<button type="submit" name="status" th:value="'Done'" th:text="'Done'"
								class="btn btn-secondary" th:classappend="${status == 'Done'} ? 'active' : ''"></button>
						</form>
					</div>
				</div>




				<!--filter by category-->
				<div class="input-group input-group-sm me-5">
					<span class="input-group-text">Filter by category</span>
					<form th:action="@{/tickets}" method="GET" class="d-flex">
						<select class="form-select" name="category">
							<option disabled selected value> -- select an option -- </option>
							<option th:each="category : ${categories}" th:text="${category.name}"
								th:value="${category.id}">
							</option>
						</select>
						<input type="submit" class="btn btn-sm btn-success">
					</form>
				</div>

				<!--create ticket button-->
				<th:block sec:authorize="hasAuthority('ADMIN')">
					<a th:href="@{/tickets/create}" class="btn btn-lg btn-primary" data-bs-toggle="tooltip"
						data-bs-placement="top" title="New Ticket"><i class="fa-solid fa-plus"></i></a>
				</th:block>
			</div>








			<!--alert after create/edit		-->
			<th:block th:if="${successMessage != null}">
				<div th:insert="~{fragments/fragments :: successAlert(${successMessage})}"></div>
			</th:block>
			<th:block th:if="${deletedMessage != null}">
				<div th:insert="~{fragments/fragments :: deletedAlert(${deletedMessage})}"></div>
			</th:block>


			<div class="col-12">
				<!--ticket table view-->
				<th:block th:if="${tickets.size > 0}">


					<table
						class="table table-custom justify-content-apart align-middle table-striped table-responsive text-center">
						<tr>
							<th>id</th>
							<th>Title</th>
							<th>Status</th>
							<th>Category</th>
							<th>Created At</th>
							<th>Last Update</th>
							<th>Priority</th>
							<th>Operator</th>
							<th>Buttons</th>

						</tr>
						<tr th:each="ticket : ${tickets}" th:object="${ticket}">
							<th>[[ *{id} ]]</th>
							<th>[[ *{title} ]]</th>
							<th>[[*{getStatus()}]] </th>
							<th>
								<div class="d-flex justify-content-center">
									<span class="badge bg-primary text-white"
										style="min-width: 100%; text-align: center;">
										<span th:text="${ticket.category.name}"></span>
									</span>
								</div>
							</th>
							<th>[[*{getFormattedCreatedAt()}]]</th>
							<th>[[*{getFormattedUpdatedAt()}]]</th>
							<th>
								<th:block th:switch="*{priority}">
									<div th:case="1">
										<span class="badge bg-primary text-white"
											style="min-width: 100%; text-align: center;">
											<span>Not Urgent</span>
										</span>
									</div>
									<div th:case="2">
										<span class="badge bg-info text-white"
											style="min-width: 100%; text-align: center;">
											<span>Moderately Urgent</span>
										</span>

									</div>
									<div th:case="3">
										<span class="badge bg-warning text-white"
											style="min-width: 100%; text-align: center;">
											<span>Urgent</span>
										</span>

									</div>
									<div th:case="4">
										<span class="badge bg-orange text-white"
											style="min-width: 100%; text-align: center;">
											<span>Very Urgent</span>
										</span>

									</div>
									<div th:case="5">
										<span class="badge bg-danger text-white"
											style="min-width: 100%; text-align: center;">
											<span>Extremely Urgent</span>
										</span>

									</div>
								</th:block>
							</th>

							<th:block th:if="${ticket.status.equals('Done') and ticket.user != null}">
								<th>Closed by [[${ticket.user.username}]]</th>
							</th:block>
							<th:block th:unless="${ticket.status.equals('Done')}">
								<th:block th:unless="${ticket.user == null}">
									<th>
										<a th:href="@{users/{id}(id=${ticket.user.id})}" data-bs-toggle="tooltip"
											data-bs-placement="top" th:title="${ticket.user.getFormattedName()}">
											<img class="img-fluid rounded-circle"
												th:src="${ticket.user.picture}+${ticket.user.id}+'.png'"
												alt="User profile picture">
										</a>



									</th>

								</th:block>
								<th:block th:if="${ticket.user == null}">
									<th th:text="'To be assigned'"></th>
								</th:block>
							</th:block>
							<th:block sec:authorize="hasAuthority('ADMIN')">
								<th>
									<a class="btn btn-primary m-1" th:href="@{tickets/{id}(id=${ticket.id})}"
										data-bs-toggle="tooltip" data-bs-placement="top" title="Show"><i
											class="fa-solid fa-file-lines"></i></a>

									<a class="btn btn-success m-1" th:href="@{tickets/edit/{id}(id=${ticket.id})}"
										data-bs-toggle="tooltip" data-bs-placement="top" title="Edit"><i
											class="fa-solid fa-pencil"></i></a>



									<!-- Button trigger modal -->
									<button type="button" class="btn btn-warning m-1" data-bs-toggle="modal"
										data-bs-placement="top" title="Delete"
										th:data-bs-target="'#delete-modal-' + ${ticket.id}">
										<i class="fa-solid fa-xmark"></i>
									</button>
									<!-- Modal -->
									<div class="modal fade" tabindex="-1" th:id="'delete-modal-' + ${ticket.id}">
										<div class="modal-dialog modal-dialog-centered">
											<div class="modal-content">
												<div class="modal-header">
													<h5 class="modal-title">Confirm delete</h5>
													<button type="button" class="btn-close" data-bs-dismiss="modal"
														aria-label="Close"></button>
												</div>
												<div class="modal-body">
													<p>Confirm delete of [[${ticket.title}]]?</p>
												</div>
												<div class="modal-footer">
													<button type="button" class="btn btn-secondary"
														data-bs-dismiss="modal">Close</button>
													<form class="d-inline-block"
														th:action="@{tickets/delete/{id}(id=${ticket.id})}"
														method="POST">
														<button type="submit" class="btn btn-danger m-1">Delete</button>
													</form>
												</div>
											</div>
										</div>
									</div>


								</th>
							</th:block>
							<th:block sec:authorize="hasAuthority('USER')">

								<th><a class="btn btn-primary m-1" th:href="@{tickets/{id}(id=${ticket.id})}">Show</a>
								</th>
							</th:block>
						</tr>

					</table>


			</div>




			</th:block>
			<th:block th:unless="${tickets.size > 0}">
				<h2 class="text-center mt-2">No ticket has been found</h2>
			</th:block>
			</div>

		</main>
		<footer th:replace="~{fragments/fragments :: footer}">

		</footer>
		<th:block th:replace="~{fragments/fragments :: scripts}"></th:block>


	</body>

</html>

